import Ss from'ip';import c from'picocolors';import cs from'cookie-parser';import ms from'cors';import Pr from'dotenv';import Ne,{urlencoded}from'express';import gs from'helmet';import {StatusCodes}from'http-status-codes';import Le from'bcryptjs';import {relations,eq,and}from'drizzle-orm';import {drizzle}from'drizzle-orm/node-postgres';import Ur from'pg';import {timestamp,text,pgEnum,pgTable,serial,integer,unique,json,decimal,bigint,varchar,uuid}from'drizzle-orm/pg-core';import Xr,{z,ZodError}from'zod';import rs from'multer';import {v2}from'cloudinary';import {doubleCsrf}from'csrf-csrf';import le from'passport';import {Strategy}from'passport-local';import as from'express-rate-limit';import ds,{Store}from'express-session';import {readFileSync}from'fs';import {join}from'path';var gr=Object.defineProperty;var _e=(r,e)=>{for(var s in e)gr(r,s,{get:e[s],enumerable:true});};function ce(r){r.get("/",(e,s)=>{s.status(200).send(`
				<!DOCTYPE html>
				<html lang="en">
				<head>
						<meta charset="UTF-8">
						<meta name="viewport" content="width=device-width, initial-scale=1.0">
						<title>Welcome Page</title>
						<style>
								body {
										font-family: Arial, sans-serif;
										background-color: #f4f4f9;
										color: #333;
										margin: 0;
										padding: 0;
										display: flex;
										justify-content: center;
										align-items: center;
										height: 100vh;
								}
								.container {
										text-align: center;
										background: white;
										padding: 20px;
										border-radius: 10px;
										box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
								}
								h1 {
										color: #4CAF50;
								}
								p {
										font-size: 1.2em;
								}
						</style>
				</head>
				<body>
						<div class="container">
								<h1>Welcome to the Application</h1>
								<p>All the API routes start with <code>/api</code></p>
								<p>For example: <code>/api/auth/login</code></p>
						</div>
				</body>
				</html>
    `);});}var he={};_e(he,{ROLE_TYPE:()=>De,TOKEN_TYPE:()=>ke,accounts:()=>re,accountsRelations:()=>Er,sessions:()=>S,sessionsRelations:()=>vr,users:()=>m,usersRelations:()=>yr,verificationToken:()=>T});var A={createdAt:timestamp("created_at",{withTimezone:true}).notNull().defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).notNull().defaultNow().$onUpdate(()=>new Date)};({metaTitle:text("meta_title").notNull().default("SEO Title"),metaDescription:text("meta_description").notNull().default("SEO Description"),metaKeywords:text("meta_keywords").notNull().default("SEO Keywords")});var Ae={enumValues:["ADMIN","SUPERVISOR"]},_={PASSWORD_RESET:"PASSWORD_RESET",enumValues:["PASSWORD_RESET","EMAIL_VERIFICATION","LOGIN_OTP"]};var De=pgEnum("role_type",Ae.enumValues),ke=pgEnum("token_type",_.enumValues),m=pgTable("users",{id:serial("id").primaryKey(),name:text("name"),username:text("username").unique(),email:text("email").unique(),password:text("password"),emailVerified:timestamp("email_verified",{withTimezone:true}),image:text("image"),role:De("role").notNull(),...A}),re=pgTable("accounts",{id:serial("id").primaryKey(),userId:integer("user_id").notNull().references(()=>m.id,{onDelete:"cascade"}),type:text("type").notNull(),provider:text("provider").notNull(),providerAccountId:text("provider_account_id").notNull(),refreshToken:text("refresh_token"),accessToken:text("access_token"),expiresAt:integer("expires_at"),tokenType:text("token_type"),scope:text("scope"),idToken:text("id_token"),sessionState:text("session_state"),...A}),S=pgTable("sessions",{id:serial("id").primaryKey(),sessionId:text("session_id").notNull().unique(),sessionCookie:text("session_cookie").unique(),userId:integer("user_id").references(()=>m.id,{onDelete:"cascade"}),expires:timestamp("expires",{withTimezone:true}).notNull(),...A}),T=pgTable("verification_token",{id:serial("id").primaryKey(),identifier:text("identifier").notNull(),token:text("token").notNull(),tokenType:ke("token_type").notNull(),expires:timestamp("expires",{withTimezone:true}).notNull(),...A},r=>[unique("verification_token_unique").on(r.identifier,r.tokenType)]),Er=relations(re,({one:r})=>({user:r(m,{fields:[re.userId],references:[m.id]})})),yr=relations(m,({many:r})=>({accounts:r(re),sessions:r(S)})),vr=relations(S,({one:r})=>({user:r(m,{fields:[S.userId],references:[m.id]})}));var Ee={};_e(Ee,{media:()=>P});var P=pgTable("media",{id:serial("id").primaryKey(),publicId:uuid("public_id").defaultRandom().notNull().unique(),filename:varchar("filename",{length:255}).notNull(),originalFilename:varchar("original_filename",{length:255}).notNull(),mimeType:varchar("mime_type",{length:100}).notNull(),fileExtension:varchar("file_extension",{length:10}).notNull(),secureUrl:text("secure_url"),fileSize:bigint("file_size",{mode:"number"}).notNull(),width:integer("width"),height:integer("height"),duration:decimal("duration",{precision:10,scale:2}),storageKey:text("storage_key").notNull(),mediaType:text("media_type").notNull(),altText:text("alt_text"),caption:text("caption"),description:text("description"),tags:json("tags"),storageMetadata:json("storage_metadata"),...A});var br={...he,...Ee},Fe=br;Pr.config();var _r=new Ur.Pool({connectionString:process.env.DATABASE_URL}),Ir=drizzle(_r,{schema:Fe}),C=Ir;var N=class{db;currentTx=null;constructor(){this.db=C;}setTransaction(e){return this.currentTx=e,this}clearTransaction(){return this.currentTx=null,this}getDb(){return this.currentTx||this.db}};var ye=class{clientDomain=null;serverDomain=null;setClientDomain(e){this.clientDomain=e;}getClientDomain(){return this.clientDomain}setServerDomain(e){this.serverDomain=e;}getServerDomain(){return this.serverDomain}},Ar=new ye,j=Ar;var g=class{static detectInputType(e){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?"EMAIL":"USERNAME"}static OTPGenerator(e=4){if(e<4)throw new Error("The OTP length must be at least 4.");let s=Math.pow(10,e-1),t=Math.pow(10,e)-1;return Math.floor(Math.random()*(t-s+1)+s)}static OTPExpiry(e=5){let s=new Date;return new Date(s.getTime()+e*6e4)}static sameSiteCookieConfig(){try{let e=x=>/^(\d{1,3}\.){3}\d{1,3}$/.test(x);if(process.env.COOKIE_SETTINGS==="locally")return {sameSite:"lax",secure:!1};if(process.env.COOKIE_SETTINGS==="globally"&&process.env.COOKIE_DOMAIN){let x=process.env.COOKIE_DOMAIN,I=x.startsWith(".")?x.substring(1):x;return e(I)?{sameSite:process.env.COOKIE_SAME_SITE,secure:!0,domain:x}:{sameSite:process.env.COOKIE_SAME_SITE,secure:!0,domain:x}}let s=j.getClientDomain(),t=j.getServerDomain()||process.env.API_URL;if(!s)return {sameSite:"none",secure:!0};let i=new URL(s),n=new URL(t),a=n.protocol==="https:",d=x=>x.split(":")[0],l=x=>{let I=d(x);if(I==="localhost"||e(I))return I;let Ue=I.split(".");return Ue.length<2?I:Ue.slice(-2).join(".")},v=l(i.hostname),Rr=l(n.hostname),ee,Y;return d(i.hostname)===d(n.hostname)?(ee=d(n.hostname),Y="lax"):v===Rr&&!e(v)&&v!=="localhost"?(ee="."+v,Y="lax"):(ee=d(n.hostname),Y="none"),Y==="none"&&(a=!0),{sameSite:Y,secure:a,domain:ee}}catch{return {sameSite:"lax",secure:true}}}};var Cr=r=>r!==null&&typeof r=="object"&&"status"in r&&typeof r.status=="number"&&"message"in r&&typeof r.message=="string",Me=new Set([StatusCodes.NO_CONTENT]),o=class{static async createResponse(e,s,t,i){return Me.has(e)?Promise.resolve({status:e,message:s,data:void 0}):Promise.resolve({status:e,message:s,data:t,pagination:i})}static async createRejectResponse(e,s){return Promise.reject({status:e,message:s})}static createErrorResponse(e){return console.error("Error:",e instanceof Error?e.message:e),Cr(e)?Promise.reject(e):Promise.reject({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Internal Server Error"})}},w=class{response;constructor(e){this.response=e;}successResponse(e,s,t){return this.sendResponse({status:StatusCodes.OK,message:e,data:s,pagination:t})}unauthorizedResponse(e){return this.sendResponse({status:StatusCodes.UNAUTHORIZED,message:e})}forbiddenResponse(e){return this.sendResponse({status:StatusCodes.FORBIDDEN,message:e})}badResponse(e){return this.sendResponse({status:StatusCodes.BAD_REQUEST,message:e})}internalServerError(e="Internal Server Error"){return this.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:e})}sendResponse({status:e,message:s,data:t,pagination:i}){if(Me.has(e))return this.response.status(e).json({});let n={status:e,message:s};return t!==void 0&&(n.data=t),i&&(n.pagination=i),this.response.status(e).json(n)}};var q=class extends N{async createUser(e){try{e.username&&await this.duplicateUserCheckByUsername(e.username),e.email&&await this.duplicateUserCheckByEmail(e.email);let s=await this.getDb().insert(m).values(e).returning(),{password:t,...i}=s[0];return o.createResponse(StatusCodes.CREATED,"User created successfully",i)}catch(s){return o.createErrorResponse(s)}}async findUserByUsernameOrEmail(e){try{let s=g.detectInputType(e),t={};return s==="EMAIL"?(t=(await this.findUserByEmail(e,!0)).data,o.createResponse(StatusCodes.OK,"User found successfully",t)):s==="USERNAME"?(t=(await this.findUserByUsername(e,!0)).data,o.createResponse(StatusCodes.OK,"User found successfully",t)):o.createResponse(StatusCodes.BAD_REQUEST,"Invalid input type",t)}catch(s){return o.createErrorResponse(s)}}async findUserById(e,s=false){try{let t=await this.getDb().query.users.findFirst({where:eq(m.id,e)});if(!t)return o.createRejectResponse(StatusCodes.NOT_FOUND,"User not found");if(s)return o.createResponse(StatusCodes.OK,"User found successfully",t);let{password:i,...n}=t;return o.createResponse(StatusCodes.OK,"User found successfully",n)}catch(t){return o.createErrorResponse(t)}}async findUserByEmail(e,s=false){try{let t=await this.getDb().query.users.findFirst({where:eq(m.email,e)});if(!t)return o.createRejectResponse(StatusCodes.NOT_FOUND,"User not found");if(s)return o.createResponse(StatusCodes.OK,"User found successfully",t);let{password:i,...n}=t;return o.createResponse(StatusCodes.OK,"User found successfully",n)}catch(t){return o.createErrorResponse(t)}}async findUserByUsername(e,s=false){try{let t=await this.getDb().query.users.findFirst({where:eq(m.username,e)});if(!t)return o.createRejectResponse(StatusCodes.NOT_FOUND,"User not found");if(s)return o.createResponse(StatusCodes.OK,"User found successfully",t);let{password:i,...n}=t;return o.createResponse(StatusCodes.OK,"User found successfully",n)}catch(t){return o.createErrorResponse(t)}}async duplicateUserCheckByEmail(e){try{return await this.getDb().query.users.findFirst({where:eq(m.email,e)})?o.createRejectResponse(StatusCodes.CONFLICT,"User already exists"):o.createResponse(StatusCodes.OK,"User does not exist",!1)}catch(s){return o.createErrorResponse(s)}}async duplicateUserCheckByUsername(e){try{return await this.getDb().query.users.findFirst({where:eq(m.username,e)})?o.createRejectResponse(StatusCodes.CONFLICT,"User already exists"):o.createResponse(StatusCodes.OK,"User does not exist",!1)}catch(s){return o.createErrorResponse(s)}}async changePassword(e,s){try{let t=await Le.hash(s,10);return await this.getDb().update(m).set({password:t}).where(eq(m.id,e)),o.createResponse(StatusCodes.OK,"Password changed successfully",!0)}catch(t){return o.createErrorResponse(t)}}async passwordChecker(e,s){try{if(!s)return o.createRejectResponse(StatusCodes.NOT_FOUND,"User account has no password");let t=await Le.compare(e,s);return t?o.createResponse(StatusCodes.OK,"Password checked",t):o.createRejectResponse(StatusCodes.NOT_FOUND,"Password incorrect")}catch(t){return o.createErrorResponse(t)}}async accountVerification(e){try{return await this.getDb().update(m).set({emailVerified:new Date}).where(eq(m.id,e)),o.createResponse(StatusCodes.OK,"User verified",!0)}catch(s){return o.createErrorResponse(s)}}async checkAccountVerification(e){try{return (await this.findUserById(e)).data?.emailVerified?o.createResponse(StatusCodes.OK,"User is verified",!0):o.createRejectResponse(StatusCodes.NOT_FOUND,"User is not verified")}catch(s){return o.createErrorResponse(s)}}};var p={error:{required:{fieldIsRequired:r=>`${r} is required.`},limit:{stringMin:(r,e)=>`${r} must be at least ${e} characters.`,stringMax:(r,e)=>`${r} must not exceed ${e} characters.`,arrayMin:(r,e)=>`${r} must have at least ${e} items.`,arrayMax:(r,e)=>`${r} must not exceed ${e} items.`,numberMin:(r,e)=>`${r} must be at least ${e}.`,numberMax:(r,e)=>`${r} must not exceed ${e}.`,fileSize:(r,e)=>`${r} must not exceed ${e}.`,length:(r,e)=>`${r} must be exactly ${e} characters long.`},invalid:{invalidString:r=>`${r} must be a string.`,invalidEmail:r=>`${r} must be a valid email address.`,invalidNumber:r=>`${r} must be a number.`,invalidBoolean:r=>`${r} must be a boolean.`,invalidDate:r=>`${r} must be a date.`,invalidArray:r=>`${r} must be an array.`,invalidObject:r=>`${r} must be an object.`,invalidEnum:(r,e)=>`${r} must be one of the following values: ${e.join(", ")}.`,invalidUnion:r=>`${r} must be one of the specified types.`,invalidIntersection:r=>`${r} must be a combination of the specified types.`,invalidTuple:r=>`${r} must be a tuple.`,invalidRecord:r=>`${r} must be a record.`,invalidLiteral:(r,e)=>`${r} must be the literal value: ${e}.`,invalidNull:r=>`${r} must be null.`,invalidUndefined:r=>`${r} must be undefined.`,invalidOptional:r=>`${r} must be optional.`,invalidNullable:r=>`${r} must be nullable.`,invalidPromise:r=>`${r} must be a promise.`,invalidFunction:r=>`${r} must be a function.`,invalidClass:r=>`${r} must be a class.`,invalidUnknown:r=>`${r} must be unknown.`,invalidNever:r=>`${r} must be never.`,invalidVoid:r=>`${r} must be void.`,invalidAny:r=>`${r} must be any.`,invalidUnknownKeys:r=>`${r} must have unknown keys.`,invalidFile:r=>`${r} must be a file.`,invalidFileSize:(r,e)=>`${r} must not exceed ${e} bytes.`,invalidFileType:(r,e)=>`${r} must be of type ${e}.`,invalidUpperCase:r=>`${r} must be at least one upper case.`,invalidLowerCase:r=>`${r} must be at least one lower case.`,invalidNumericCase:r=>`${r} must be at least one number.`,invalidPhoneNumber:r=>`${r} must be a valid phone number.`,invalidUsername:r=>`${r} must contain only letters, numbers, and underscores.`,invalidUsernameOrEmail:r=>`${r} must be a valid username or email address.`}}};var R=r=>z.string({error:e=>e.input===void 0?p.error.required.fieldIsRequired(r):p.error.invalid.invalidString(r)}).min(1,p.error.required.fieldIsRequired(r));var ve=r=>z.number({error:e=>e.input===void 0?p.error.required.fieldIsRequired(r):p.error.invalid.invalidString(r)}).min(1,p.error.required.fieldIsRequired(r)).int().positive();var B=(r,e)=>z.enum(e,{error:s=>s.input===void 0?p.error.required.fieldIsRequired(r):p.error.invalid.invalidString(r)});z.string({error:r=>r.input===void 0?p.error.required.fieldIsRequired("Username"):p.error.invalid.invalidString("Username")}).min(1,p.error.required.fieldIsRequired("Username")).max(20,p.error.limit.stringMax("Username",20)).regex(new RegExp("^[a-zA-Z0-9_]*$"),p.error.invalid.invalidUsername("Username"));var oe=z.email(p.error.invalid.invalidEmail("Email")).min(1,p.error.required.fieldIsRequired("Email"));var ze=z.string({error:r=>r.input===void 0?p.error.required.fieldIsRequired("Username or email"):p.error.invalid.invalidString("Username or email")}).min(1,p.error.required.fieldIsRequired("Username or email")).max(255,p.error.limit.numberMax("Username or email",255)).refine(r=>{let e=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,s=/^[a-zA-Z0-9_]*$/;return r.includes("@")?e.test(r):s.test(r)&&r.length>=1&&r.length<=20},p.error.invalid.invalidUsernameOrEmail("Username or email")),Se=z.string({error:r=>r.input===void 0?p.error.required.fieldIsRequired("Password"):p.error.invalid.invalidString("Password")}).min(1,p.error.required.fieldIsRequired("Password")).min(6,p.error.limit.stringMin("Password",6)).regex(new RegExp(".*[A-Z].*"),p.error.invalid.invalidUpperCase("Password")).regex(new RegExp(".*[a-z].*"),p.error.invalid.invalidLowerCase("Password")).regex(new RegExp(".*\\d.*"),p.error.invalid.invalidNumericCase("Password")),je=z.string({error:r=>r.input===void 0?p.error.required.fieldIsRequired("New Password"):p.error.invalid.invalidString("New Password")}).min(1,p.error.required.fieldIsRequired("New Password")).min(6,p.error.limit.stringMin("New Password",6)).regex(new RegExp(".*[A-Z].*"),p.error.invalid.invalidUpperCase("New Password")).regex(new RegExp(".*[a-z].*"),p.error.invalid.invalidLowerCase("New Password")).regex(new RegExp(".*\\d.*"),p.error.invalid.invalidNumericCase("New Password"));z.string({error:r=>r.input===void 0?p.error.required.fieldIsRequired("Confirm Password"):p.error.invalid.invalidString("Confirm Password")}).min(1,p.error.required.fieldIsRequired("Confirm Password")).min(6,p.error.limit.stringMin("Confirm Password",6)).regex(new RegExp(".*[A-Z].*"),p.error.invalid.invalidUpperCase("Confirm Password")).regex(new RegExp(".*[a-z].*"),p.error.invalid.invalidLowerCase("Confirm Password")).regex(new RegExp(".*\\d.*"),p.error.invalid.invalidNumericCase("Confirm Password"));var Be=r=>z.boolean({error:e=>e.input===void 0?p.error.required.fieldIsRequired(r):p.error.invalid.invalidString(r)});var Ke=z.object({usernameOrEmail:ze,password:R("Password")}),Ve=z.object({email:oe}),He=z.object({email:oe,otp:ve("OTP"),verificationMethod:B("Verification Method",_.enumValues)}),We=z.object({email:oe,otp:ve("OTP"),password:Se});z.object({oldPassword:Se,newPassword:je});var K=class{request;response;apiResponse;constructor(e,s){this.request=e,this.response=s,this.apiResponse=new w(s);}};var Z=class extends N{async limitOTPRequest(e,s,t){try{let i=await this.getDb().query.verificationToken.findFirst({where:and(eq(T.identifier,e.email),eq(T.tokenType,s))}),n=new Date().getTime(),a=new Date(i?.updatedAt).getTime(),d=n-a,l=Math.floor(d/6e4);if(i&&l<t){let v=`You can only request OTP per ${t} minute(s). Please wait for ${t-l} minute(s)`;return o.createRejectResponse(StatusCodes.TOO_MANY_REQUESTS,v)}return Promise.resolve(!0)}catch(i){return o.createErrorResponse(i)}}async saveOTPToDatabase(e,s,t=Number(process.env.OTP_RESET_EXPIRY)){try{if(!e.email)return o.createRejectResponse(StatusCodes.NOT_FOUND,"Email is not registered");let i=new Date,n=new Date(i.getTime()+t*6e4);await this.limitOTPRequest(e,s,t);let a=g.OTPGenerator(6),d=Le.hashSync(String(a),10);return await this.getDb().insert(T).values({identifier:e.email,token:d,tokenType:s,expires:n}).onConflictDoUpdate({target:[T.identifier,T.tokenType],set:{token:d,expires:n}}),Promise.resolve(a)}catch(i){return o.createErrorResponse(i)}}async verifyOTPFromDatabase(e,s,t){try{let i=await this.getDb().query.verificationToken.findFirst({where:and(eq(T.identifier,e.email),eq(T.tokenType,t))});return i&&i.token&&!Le.compareSync(s,i.token)?o.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid OTP"):i?i?.expires&&i.expires<new Date?(await this.deleteOTPFromDatabase(e,t),o.createRejectResponse(StatusCodes.REQUEST_TIMEOUT,"OTP expired")):Promise.resolve(!0):o.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid OTP")}catch(i){return o.createErrorResponse(i)}}async deleteOTPFromDatabase(e,s){try{return await this.getDb().delete(T).where(and(eq(T.identifier,e.email),eq(T.tokenType,s))),Promise.resolve(!0)}catch(t){return o.createErrorResponse(t)}}};var b=class extends K{authenticationService;otpService;constructor(e,s){super(e,s),this.authenticationService=new q,this.otpService=new Z;}async getSession(){let{user:e}=this.request;return e?this.apiResponse.successResponse("Authorized",e):this.apiResponse.successResponse("No session found")}async verifyOTP(){let{body:e}=this.request,s=He.safeParse(e);if(!s.success)return this.apiResponse.badResponse(s.error.issues.map(i=>i.message).join(" "));let t=await this.authenticationService.findUserByEmail(s.data.email);return await this.otpService.verifyOTPFromDatabase(t.data,String(s.data.otp),s.data.verificationMethod),this.apiResponse.successResponse("OTP verified successfully")}async login(){let{body:e}=this.request,s=Ke.safeParse(e);if(!s.success)return this.apiResponse.badResponse(s.error.issues.map(a=>a.message).join(" "));let t=await this.authenticationService.findUserByUsernameOrEmail(s.data.usernameOrEmail);await this.authenticationService.checkAccountVerification(t.data.id),await this.authenticationService.passwordChecker(s.data.password,t.data.password);let{password:i,...n}=t.data;this.request.login(t.data,a=>a?this.apiResponse.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Login failed"}):this.apiResponse.successResponse("Login successful",n));}async logout(){this.request.session.destroy(e=>e?this.apiResponse.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Error logging out"}):(this.response.clearCookie(process.env.SESSION_COOKIE_NAME),this.apiResponse.successResponse("Logged out")));}async resetPasswordOTPRequest(){let{body:e}=this.request,s=Ve.safeParse(e);if(!s.success)return this.apiResponse.badResponse(s.error.issues.map(n=>n.message).join(" "));let t=await this.authenticationService.findUserByEmail(e.email),i=await this.otpService.saveOTPToDatabase(t.data,_.PASSWORD_RESET);return i&&t.data.email,process.env.SHOW_OTP?(console.log(`OTP for user ${t.data.username}: ${i}`),this.apiResponse.successResponse("OTP sent to your email",{otp:i,otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})):this.apiResponse.successResponse("Password reset OTP sent",{otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})}async resetPasswordConfirm(){let{body:e}=this.request,s=We.safeParse(e);if(!s.success)return this.apiResponse.badResponse(s.error.issues.map(i=>i.message).join(", "));let t=await this.authenticationService.findUserByEmail(s.data.email);return await this.otpService.verifyOTPFromDatabase(t.data,String(s.data.otp),_.PASSWORD_RESET),await this.otpService.deleteOTPFromDatabase(t.data,_.PASSWORD_RESET),await this.authenticationService.changePassword(t.data.id,s.data.password),this.apiResponse.successResponse("User password reset")}};function kr(r,e,s,t){let i=new w(s);if($r(r,e),r instanceof ZodError){Fr(r,i);return}if(r.name==="ValidationError"){Mr(r,i);return}if(r.name==="CastError"){Lr(r,i);return}if(r.name==="MongoError"||r.name==="MongoServerError"){zr(r,i);return}if(r.code==="ECONNREFUSED"){jr(r,i);return}if(r.name==="JsonWebTokenError"){Br(r,i);return}if(r.name==="TokenExpiredError"){Kr(r,i);return}if(r.name==="SyntaxError"&&r.message.includes("JSON")){Vr(r,i);return}if(r.code==="LIMIT_FILE_SIZE"){Hr(r,i);return}if(r.code==="EBADCSRFTOKEN"){Wr(r,i);return}if(r.status||r.statusCode){Yr(r,i);return}Gr(r,i);}function qr(r,e){new w(e).sendResponse({status:StatusCodes.NOT_FOUND,message:`Route ${r.method} ${r.originalUrl} not found`});}function h(r){return (e,s,t)=>{Promise.resolve(r(e,s,t)).catch(t);}}function Qe(r){r.use(qr),r.use(kr);}function $r(r,e){let s=new Date().toISOString(),t=e.method,i=e.originalUrl,n=e.get("User-Agent")||"Unknown",a=e.ip||e.socket.remoteAddress||"Unknown";console.error(c.red("=".repeat(80))),console.error(c.red(`\u{1F6A8} ERROR OCCURRED AT: ${s}`)),console.error(c.yellow(`\u{1F4DD} REQUEST: ${t} ${i}`)),console.error(c.cyan(`\u{1F310} IP: ${a}`)),console.error(c.cyan(`\u{1F50D} User-Agent: ${n}`)),console.error(c.red(`\u274C ERROR NAME: ${r.name||"Unknown"}`)),console.error(c.red(`\u{1F4AC} ERROR MESSAGE: ${r.message||"No message"}`)),r.stack&&(console.error(c.gray("\u{1F4DA} STACK TRACE:")),console.error(c.gray(r.stack))),console.error(c.red("=".repeat(80)));}function Fr(r,e){let s=r.issues.map(t=>({field:t.path.join("."),message:t.message}));e.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:s}});}function Mr(r,e){let s=Object.values(r.issues||{}).map(t=>({field:t.path,message:t.message}));e.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:s}});}function Lr(r,e){e.badResponse(`Invalid ${r.path}: ${r.value}`);}function zr(r,e){if(r.code===11e3){let s=Object.keys(r.keyValue||{})[0];e.sendResponse({status:StatusCodes.CONFLICT,message:`Duplicate value for field: ${s}`});return}e.internalServerError("Database operation failed");}function jr(r,e){e.sendResponse({status:StatusCodes.SERVICE_UNAVAILABLE,message:"Database connection failed. Please try again later."});}function Br(r,e){e.unauthorizedResponse("Invalid authentication token");}function Kr(r,e){e.unauthorizedResponse("Authentication token has expired");}function Vr(r,e){e.badResponse("Invalid JSON format in request body");}function Hr(r,e){e.badResponse("File size exceeds the allowed limit");}function Wr(r,e){e.forbiddenResponse("Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.");}function Yr(r,e){let s=r.status||r.statusCode||StatusCodes.INTERNAL_SERVER_ERROR,t=r.message||"An error occurred";e.sendResponse({status:s,message:t});}function Gr(r,e){e.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Something went wrong. Please try again later."});}function Ze(){process.on("uncaughtException",r=>{console.error(c.red("\u{1F6A8} UNCAUGHT EXCEPTION:")),console.error(c.red(r.name+": "+r.message)),console.error(c.gray(r.stack)),console.log(c.yellow("\u{1F504} Attempting graceful shutdown...")),process.exit(1);}),process.on("unhandledRejection",(r,e)=>{console.error(c.red("\u{1F6A8} UNHANDLED PROMISE REJECTION:")),console.error(c.red("Reason:"),r),console.error(c.yellow("Promise:"),e),console.log(c.yellow("\u26A0\uFE0F  Server continues running despite unhandled rejection")),(r&&r.code==="ECONNREFUSED"||r?.message?.includes("FATAL"))&&(console.log(c.yellow("\u{1F504} Critical error detected. Attempting graceful shutdown...")),process.exit(1));}),process.on("SIGTERM",()=>{console.log(c.yellow("\u{1F6D1} SIGTERM received. Starting graceful shutdown...")),process.exit(0);}),process.on("SIGINT",()=>{console.log(c.yellow("\u{1F6D1} SIGINT received. Starting graceful shutdown...")),process.exit(0);});}var Qr=process.env.SESSION_COOKIE_NAME,Zr=async(r,e,s)=>{let t=new w(e);if(!r.isAuthenticated()){e.clearCookie(Qr),t.unauthorizedResponse("Unauthorized: Not authenticated");return}s();},Je=h(Zr);var Xe=(()=>{let r=Ne.Router();return r.get("/me",h(async(e,s)=>{await new b(e,s).getSession();})),r.post("/verify-otp",h(async(e,s)=>{await new b(e,s).verifyOTP();})),r.post("/login",h(async(e,s)=>{await new b(e,s).login();})),r.post("/reset-password/request",h(async(e,s)=>{await new b(e,s).resetPasswordOTPRequest();})),r.post("/reset-password/confirm",h(async(e,s)=>{await new b(e,s).resetPasswordConfirm();})),r.post("/logout",Je,h(async(e,s)=>{await new b(e,s).logout();})),r})();var F=["image/jpeg","image/jpg","image/png","image/gif","image/webp","image/svg+xml","video/mp4","video/webm","audio/mp3","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"];var W=class{constructor(){v2.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET});}async singleUpload(e){try{if(!e)return o.createRejectResponse(StatusCodes.BAD_REQUEST,"No file provided for upload");if(typeof e=="string"){if(!this.isValidUrl(e))return o.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid URL provided for upload");let t=await v2.uploader.upload(e,{resource_type:"auto"});return o.createResponse(StatusCodes.OK,"Upload successful",t)}if(e instanceof Buffer){if(e.length===0)return o.createRejectResponse(StatusCodes.BAD_REQUEST,"Empty buffer provided for upload");let t=await this.uploadBuffer(e);return o.createResponse(StatusCodes.OK,"Upload successful",t)}let s=e;if(!this.isValidMulterFile(s))return o.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid file format or corrupted file");if(s.buffer){let t=await this.uploadBufferWithMetadata(s.buffer,{originalname:s.originalname,mimetype:s.mimetype,size:s.size,fieldname:s.fieldname,encoding:s.encoding});return o.createResponse(StatusCodes.OK,"Upload successful",t)}if(s.path){let t={resource_type:this.getResourceType(s.mimetype),context:{original_filename:s.originalname,mime_type:s.mimetype,file_size:s.size.toString(),field_name:s.fieldname,encoding:s.encoding}},i=await v2.uploader.upload(s.path,t);return o.createResponse(StatusCodes.OK,"Upload successful",i)}return o.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid file - no buffer or path found")}catch(s){return s.message?.includes("Invalid image file")||s.http_code===400?o.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid file format. This file type may not be supported or the file may be corrupted. Please try uploading a different file."):s.message?.includes("File size too large")?o.createRejectResponse(StatusCodes.BAD_REQUEST,"File size exceeds the maximum allowed limit."):o.createRejectResponse(StatusCodes.INTERNAL_SERVER_ERROR,"Upload service temporarily unavailable. Please try again later.")}}uploadBuffer(e,s){return new Promise((t,i)=>{try{let n={resource_type:s?this.getResourceType(s):"auto"};v2.uploader.upload_stream(n,(d,l)=>{d?d.message?.includes("Invalid image file")||d.http_code===400?i(new Error("Invalid file format. Please upload a valid file.")):i(new Error("Upload service temporarily unavailable.")):l?t(l):i(new Error("Upload failed - no result returned"));}).end(e);}catch{i(new Error("Failed to initialize upload process"));}})}uploadBufferWithMetadata(e,s){return new Promise((t,i)=>{try{let n={resource_type:this.getResourceType(s.mimetype),context:{original_filename:s.originalname,mime_type:s.mimetype,file_size:s.size.toString(),field_name:s.fieldname,encoding:s.encoding},tags:["uploaded_file"]};v2.uploader.upload_stream(n,(d,l)=>{d?d.message?.includes("Invalid image file")||d.http_code===400?i(new Error("Invalid file format. Please upload a valid file.")):i(new Error("Upload service temporarily unavailable.")):l?t(l):i(new Error("Upload failed - no result returned"));}).end(e);}catch{i(new Error("Failed to initialize upload process"));}})}async multipleUpload(e){try{if(!e||e.length===0)return o.createRejectResponse(StatusCodes.BAD_REQUEST,"No files provided for upload");let s=e.map(a=>this.singleUpload(a)),t=await Promise.allSettled(s),i=[],n=[];return t.forEach((a,d)=>{a.status==="fulfilled"?a.value.status>=200&&a.value.status<300&&a.value.data?i.push(a.value.data):n.push(`File ${d+1}: ${a.value.message||"Upload failed"}`):n.push(`File ${d+1}: ${a.reason?.message||"Upload failed"}`);}),i.length===0?o.createRejectResponse(StatusCodes.BAD_REQUEST,`All uploads failed: ${n.join(", ")}`):(n.length>0&&console.warn("Some files failed to upload:",n),o.createResponse(StatusCodes.OK,`Upload successful (${i.length}/${e.length} files)`,i))}catch{return o.createRejectResponse(StatusCodes.INTERNAL_SERVER_ERROR,"Upload service temporarily unavailable. Please try again later.")}}async deleteFile(e){try{return (await v2.uploader.destroy(e)).result==="ok"}catch{return  false}}isValidUrl(e){try{return new URL(e),!0}catch{return  false}}isValidMulterFile(e){return !e||!e.buffer&&!e.path||!e.originalname||!e.mimetype||!e.size||e.size===0||e.size>50*1024*1024?false:F.includes(e.mimetype.toLowerCase())}getResourceType(e){let s=e.toLowerCase();return s.startsWith("image/")?"image":s.startsWith("video/")?"video":s.startsWith("text/")||s.startsWith("application/")||s.startsWith("audio/")?"raw":"auto"}};var J=class extends N{cloudinarySettings;constructor(){super(),this.cloudinarySettings=new W;}async upload(e){try{let s=(a,d)=>{if(d)return d;let l=a.lastIndexOf(".");return l!==-1?a.substring(l+1):""},t=(a,d,l)=>l||(d?`${a}/${d}`:"application/octet-stream"),i=s(e.original_filename,e.format),n=t(e.resource_type,e.format,e.context?.custom?.mime_type);return await this.getDb().insert(P).values({filename:e.display_name,originalFilename:e.original_filename,mediaType:e.resource_type,fileSize:e.bytes,fileExtension:i,mimeType:n,storageKey:e.public_id,height:e.height,width:e.width,secureUrl:e.secure_url,storageMetadata:e,altText:e.original_filename||""}),o.createResponse(StatusCodes.OK,"Media uploaded successfully",!0)}catch(s){return o.createErrorResponse(s)}}async retrieveAll(){try{let e=await this.getDb().query.media.findMany({orderBy:(s,{desc:t})=>t(s.createdAt)});return o.createResponse(StatusCodes.OK,"Media retrieved successfully",e)}catch(e){return o.createErrorResponse(e)}}async updateMediaFileName(e,s,t){try{return await this.getDb().update(P).set({originalFilename:s,altText:t}).where(eq(P.id,e)),o.createResponse(StatusCodes.OK,"Media file name updated",!0)}catch(i){return o.createErrorResponse(i)}}async downloadMedia(e){try{let s=await this.getDb().query.media.findFirst({where:eq(P.id,e)});return s?o.createResponse(StatusCodes.OK,"Media information retrieved successfully",s):o.createRejectResponse(StatusCodes.NOT_FOUND,"Media item not found")}catch(s){return o.createErrorResponse(s)}}async deleteMedia(e){try{let s=await this.getDb().query.media.findFirst({where:eq(P.id,e)});return s?(await this.cloudinarySettings.deleteFile(s.storageKey),await this.getDb().delete(P).where(eq(P.id,e)),o.createResponse(StatusCodes.OK,"Media deleted successfully",!0)):o.createRejectResponse(StatusCodes.NOT_FOUND,"Media item not found")}catch(s){return o.createErrorResponse(s)}}};var er=Xr.object({name:R("Media Name"),altText:R("Alt Text").optional()});var U=class extends K{cloudinarySettings;mediaService;constructor(e,s){super(e,s),this.cloudinarySettings=new W,this.mediaService=new J;}async index(){let e=await this.mediaService.retrieveAll();return this.apiResponse.sendResponse(e)}async upload(){let e=this.request.files;if(!e||e.length===0)return this.apiResponse.badResponse("No files provided for upload.");let s=await this.cloudinarySettings.multipleUpload(e);if(s.status<200||s.status>=300||!s.data||s.data.length===0)return this.apiResponse.badResponse(s.message||"Upload failed - no data returned");let t={...s.data[0],original_filename:e[0].originalname,asset_id:s.data[0].asset_id,version_id:s.data[0].version_id,asset_folder:s.data[0].asset_folder,display_name:s.data[0].display_name,api_key:s.data[0].api_key},i=await this.mediaService.upload(t);return this.apiResponse.sendResponse(i)}async updateFileName(){let{body:e,params:s}=this.request,t=Number(s.id);if(isNaN(t))return this.apiResponse.badResponse("Invalid media ID provided.");let i=er.safeParse(e);if(!i.success)return this.apiResponse.badResponse(i.error.issues.map(a=>a.message).join(", "));let n=await this.mediaService.updateMediaFileName(t,i.data.name,i.data.altText);return this.apiResponse.sendResponse(n)}async download(){let{params:e,query:s}=this.request,t=Number(e.id);if(isNaN(t))return this.apiResponse.badResponse("Invalid media ID provided.");let n=(await this.mediaService.downloadMedia(t)).data;return n.secureUrl?(this.response.setHeader("Content-Type",n.mimeType),this.response.setHeader("Content-Disposition",`attachment; filename="${n.originalFilename}"`),n.fileSize&&this.response.setHeader("Content-Length",n.fileSize.toString()),this.response.setHeader("Cache-Control","public, max-age=3600"),this.response.setHeader("ETag",`"${n.id}-${n.updatedAt}"`),s.stream==="true"?this.apiResponse.sendResponse({status:StatusCodes.OK,message:"Streaming not implemented in this version. Use direct download.",data:{downloadUrl:n.secureUrl}}):(this.response.redirect(StatusCodes.TEMPORARY_REDIRECT,n.secureUrl),this.response)):this.apiResponse.internalServerError("Media URL not available")}async delete(){let{params:e}=this.request,s=Number(e.id);if(isNaN(s))return this.apiResponse.badResponse("Invalid media ID provided.");let t=await this.mediaService.deleteMedia(s);return this.apiResponse.sendResponse(t)}};var sr=(r,e,s)=>{let t=r.files,i=new w(e);if(!t||t.length===0)return i.badResponse("No files uploaded");if(t.length>1)return i.badResponse(`Maximum ${1} files allowed per upload`);for(let n of t){if(n.size>10485760)return i.badResponse(`File ${n.originalname} exceeds maximum size of ${10485760/(1024*1024)}MB`);if(!F.includes(n.mimetype))return i.badResponse(`File type ${n.mimetype} is not allowed. Allowed types: ${F.join(", ")}`);if(!n.originalname||n.originalname.trim()==="")return i.badResponse("File must have a valid name");let a=[".exe",".bat",".cmd",".com",".pif",".scr",".vbs",".js"],d=n.originalname.toLowerCase().substring(n.originalname.lastIndexOf("."));if(a.includes(d))return i.badResponse(`File type ${d} is not allowed for security reasons`)}s();};var ss=rs({limits:{fileSize:10485760,files:1},fileFilter:(r,e,s)=>{F.includes(e.mimetype)?s(null,true):s(new Error(`File type ${e.mimetype} is not allowed`));}}),tr=(()=>{let r=Ne.Router();return r.get("",h(async(e,s)=>{await new U(e,s).index();})),r.post("/upload",ss.any(),sr,h(async(e,s)=>{await new U(e,s).upload();})),r.route("/:id").put(h(async(e,s)=>{await new U(e,s).updateFileName();})).delete(h(async(e,s)=>{await new U(e,s).delete();})),r.get("/:id/download",h(async(e,s)=>{await new U(e,s).download();})),r})();var{generateCsrfToken:ir,validateRequest:Ai,doubleCsrfProtection:Ci,invalidCsrfTokenError:Di}=doubleCsrf({getSecret:()=>process.env.SECRET,getSessionIdentifier:()=>process.env.SECRET,cookieName:"csrf-token",cookieOptions:{maxAge:36e5,sameSite:g.sameSiteCookieConfig().sameSite,secure:g.sameSiteCookieConfig().secure,...g.sameSiteCookieConfig().domain&&{domain:g.sameSiteCookieConfig().domain}},size:32,errorConfig:{message:"Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.",statusCode:403},getCsrfTokenFromRequest:r=>r.headers["x-csrf-token"]});var or=(()=>{let r=Ne.Router();return r.get("",h(async(e,s)=>{let t=ir(e,s);new w(s).successResponse("CSRF token generated",t);})),r})();var nr=[{path:"/csrf-token",router:or},{path:"/auth",router:Xe},{path:"/media",router:tr}];function Te(r,e=""){let s=[];for(let{path:t,router:i}of nr){let n=`${e}${t}`;r.use(n,i),i.stack.forEach(a=>{a.route&&Object.keys(a.route.methods).forEach(l=>{s.push({method:l.toUpperCase(),path:`${n}${a.route.path}`});});});}}var ar={origin:function(r,e){!r||process.env.ORIGIN_URL.split(",").includes(r)?e(null,true):e(new Error("Not allowed by CORS"));},credentials:true,methods:["GET","POST","PUT","DELETE"],allowedHeaders:["Content-Type","Authorization","x-csrf-token","ngrok-skip-browser-warning"],maxAge:3600};function xe(r){r.use((e,s,t)=>{let{method:i,url:n}=e,a=Date.now();console.log(`${c.green("\u2713")} ${i} ${n}`),s.on("finish",()=>{let d=Date.now()-a,l=s.statusCode,v;l>=500?v=c.red(l.toString()):l>=400?v=c.yellow(l.toString()):l>=300?v=c.cyan(l.toString()):l>=200?v=c.green(l.toString()):v=c.red("500"),console.log(`${c.green("\u2713")} ${i} ${n} ${v} in ${d}ms`);}),t();});}var de=new q;le.serializeUser((r,e)=>{e(null,r.id);});le.deserializeUser(async(r,e)=>{try{let s=await de.findUserById(r,!1);s.data?e(null,s.data):e(new Error("User not found"),null);}catch(s){e(s,null);}});le.use(new Strategy({usernameField:"usernameOrEmail",passwordField:"password"},async(r,e,s)=>{try{let t=await de.findUserByUsernameOrEmail(r);if(!t.data)return s(null,!1,{message:"Invalid credentials"});if(!(await de.passwordChecker(e,t.data.password)).data)return s(null,!1,{message:"Invalid credentials"});let n=await de.findUserById(t.data.id,!1);return s(null,n.data)}catch(t){return s(t)}}));var Oe=le;function be(r){let e=as({windowMs:9e5,max:100,message:"Too many requests, please try again later."});r.use(e);}var X=class extends Store{async get(e,s){try{let t=await C.select().from(S).where(eq(S.sessionId,e)).execute();if(!t||t.length===0)return s(null,null);let i=t[0];return new Date(i.expires)<new Date?(await this.destroy(e),s(null,null)):s(null,JSON.parse(i.sessionCookie))}catch(t){return s(t)}}async set(e,s,t){try{if(!s)return t?.();let i=JSON.stringify(s),n=s.cookie.expires||new Date(Date.now()+6048e5),a=s?.passport?.user||null;await C.insert(S).values({sessionId:e,sessionCookie:i,userId:a,expires:n}).onConflictDoUpdate({target:S.sessionId,set:{sessionCookie:i,userId:a,expires:n}}).returning(),t?.();}catch(i){t?.(i);}}async destroy(e,s){try{await C.delete(S).where(eq(S.sessionId,e)).execute(),s?.();}catch(t){s?.(t);}}async touch(e,s,t){try{let i=s.cookie.expires||new Date(Date.now()+6048e5);await C.update(S).set({expires:i}).where(eq(S.sessionId,e)).execute(),t?.();}catch{t?.();}}};var ls=ds({name:process.env.SESSION_COOKIE_NAME,secret:process.env.SECRET,saveUninitialized:false,resave:false,store:new X,cookie:{sameSite:g.sameSiteCookieConfig().sameSite,secure:g.sameSiteCookieConfig().secure,maxAge:6048e5,...g.sameSiteCookieConfig().domain&&{domain:g.sameSiteCookieConfig().domain}}}),pr=ls;var us=(r,e,s)=>{let t=r.secure?"https":"http",i=r.headers.origin||r.headers.referer||"Unknown",n=i!=="Unknown"?new URL(i.toString()).origin:"Unknown",a=r.headers.host?`${t}://${r.headers.host}`:"Unknown";j.setClientDomain(n),j.setServerDomain(a),s();},dr=us;Pr.config();var E=Ne();E.use(gs());E.use(Ne.json());E.use(urlencoded({extended:true}));E.use(Ne.urlencoded({extended:true}));E.use(cs());E.use(ms(ar));xe(E);be(E);E.use(dr);E.set("trust proxy",1);E.use(pr);E.use(Oe.initialize());E.use(Oe.session());ce(E);Te(E);Qe(E);var lr=E;var ys=z.object({DATABASE_URL:R("DATABASE_URL"),PORT:R("PORT").refine(r=>!isNaN(Number(r)),"PORT must be a number"),SECRET:R("SECRET"),NODE_ENV:B("NODE_ENV",["development","production"]),SESSION_COOKIE_NAME:R("SESSION_COOKIE_NAME"),ORIGIN_URL:R("ORIGIN_URL"),COOKIE_SETTINGS:B("COOKIE_SETTINGS",["locally","globally"]),COOKIE_DOMAIN:R("COOKIE_DOMAIN"),COOKIE_SAME_SITE:B("COOKIE_SAME_SITE",["lax","strict","none"]),OTP_RESET_EXPIRY:R("OTP_RESET_EXPIRY").refine(r=>!isNaN(Number(r)),"OTP_RESET_EXPIRY must be a number"),SHOW_OTP:R("SHOW_OTP").refine(r=>Be(r)?true:"SHOW_OTP must be a boolean value (true or false)"),API_URL:R("API_URL"),CLOUDINARY_CLOUD_NAME:R("CLOUDINARY_CLOUD_NAME"),CLOUDINARY_API_KEY:R("CLOUDINARY_API_KEY"),CLOUDINARY_API_SECRET:R("CLOUDINARY_API_SECRET")}),ur=ys.safeParse(process.env);if(!ur.success){let r=ur.error.issues.map(e=>e.message).join(`
`);console.error(c.red(`Environment validation failed:
${r}`)),process.exit(1);}var vs=()=>{try{let r=join(process.cwd(),"package.json"),e=JSON.parse(readFileSync(r,"utf-8")),s=e.dependencies?.express||e.devDependencies?.express;if(s)return s.replace(/[\^~<>=\s]/g,"");let t=join(process.cwd(),"node_modules/express/package.json");return JSON.parse(readFileSync(t,"utf-8")).version}catch{return "unknown"}},fr=vs;var Ts=fr();Ze();var xs=async()=>{try{let r=process.env.PORT||8080,e=Ss.address(),s="production";lr.listen(r,()=>{console.log(c.magenta(`
\u25B2 Express.js ${Ts}`)),console.log(`- Local:        http://localhost:${r}`),console.log(`- Network:      http://${e}:${r}`),console.log(`- Environment:  ${s}`),console.log();});}catch(r){console.error("Failed to start server:",r),process.exit(1);}};xs();