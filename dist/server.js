import ys from'ip';import u from'picocolors';import ds from'cookie-parser';import us from'cors';import Or from'dotenv';import Ne,{urlencoded}from'express';import fs from'helmet';import {StatusCodes}from'http-status-codes';import Le from'bcryptjs';import {relations,eq,and}from'drizzle-orm';import {drizzle}from'drizzle-orm/node-postgres';import Pr from'pg';import {timestamp,text,pgEnum,pgTable,serial,integer,unique,json,decimal,bigint,varchar}from'drizzle-orm/pg-core';import Jr,{z as z$1,ZodError}from'zod';import Qr from'multer';import {v2}from'cloudinary';import {doubleCsrf}from'csrf-csrf';import ce from'passport';import {Strategy}from'passport-local';import is from'express-rate-limit';import as,{Store}from'express-session';import {readFileSync}from'fs';import {join}from'path';var Rr=Object.defineProperty;var _e=(r,e)=>{for(var s in e)Rr(r,s,{get:e[s],enumerable:true});};function ue(r){r.get("/",(e,s)=>{s.status(200).send(`
				<!DOCTYPE html>
				<html lang="en">
				<head>
						<meta charset="UTF-8">
						<meta name="viewport" content="width=device-width, initial-scale=1.0">
						<title>Welcome Page</title>
						<style>
								body {
										font-family: Arial, sans-serif;
										background-color: #f4f4f9;
										color: #333;
										margin: 0;
										padding: 0;
										display: flex;
										justify-content: center;
										align-items: center;
										height: 100vh;
								}
								.container {
										text-align: center;
										background: white;
										padding: 20px;
										border-radius: 10px;
										box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
								}
								h1 {
										color: #4CAF50;
								}
								p {
										font-size: 1.2em;
								}
						</style>
				</head>
				<body>
						<div class="container">
								<h1>Welcome to the Application</h1>
								<p>All the API routes start with <code>/api</code></p>
								<p>For example: <code>/api/auth/login</code></p>
						</div>
				</body>
				</html>
    `);});}var ge={};_e(ge,{ROLE_TYPE:()=>De,TOKEN_TYPE:()=>ke,accounts:()=>re,accountsRelations:()=>hr,sessions:()=>S,sessionsRelations:()=>yr,users:()=>m,usersRelations:()=>Er,verificationToken:()=>w});var _={createdAt:timestamp("created_at",{withTimezone:true}).notNull().defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).notNull().defaultNow().$onUpdate(()=>new Date)};({metaTitle:text("meta_title").notNull().default("SEO Title"),metaDescription:text("meta_description").notNull().default("SEO Description"),metaKeywords:text("meta_keywords").notNull().default("SEO Keywords")});var Ae={enumValues:["ADMIN","SUPERVISOR"]},P={PASSWORD_RESET:"PASSWORD_RESET",enumValues:["PASSWORD_RESET","EMAIL_VERIFICATION","LOGIN_OTP"]};var De=pgEnum("role_type",Ae.enumValues),ke=pgEnum("token_type",P.enumValues),m=pgTable("users",{id:serial("id").primaryKey(),name:text("name"),username:text("username").unique(),email:text("email").unique(),password:text("password"),emailVerified:timestamp("email_verified",{withTimezone:true}),image:text("image"),role:De("role").notNull(),..._}),re=pgTable("accounts",{id:serial("id").primaryKey(),userId:integer("user_id").notNull().references(()=>m.id,{onDelete:"cascade"}),type:text("type").notNull(),provider:text("provider").notNull(),providerAccountId:text("provider_account_id").notNull(),refreshToken:text("refresh_token"),accessToken:text("access_token"),expiresAt:integer("expires_at"),tokenType:text("token_type"),scope:text("scope"),idToken:text("id_token"),sessionState:text("session_state"),..._}),S=pgTable("sessions",{id:serial("id").primaryKey(),sessionId:text("session_id").notNull().unique(),sessionCookie:text("session_cookie").unique(),userId:integer("user_id").references(()=>m.id,{onDelete:"cascade"}),expires:timestamp("expires",{withTimezone:true}).notNull(),..._}),w=pgTable("verification_token",{id:serial("id").primaryKey(),identifier:text("identifier").notNull(),token:text("token").notNull(),tokenType:ke("token_type").notNull(),expires:timestamp("expires",{withTimezone:true}).notNull(),..._},r=>[unique("verification_token_unique").on(r.identifier,r.tokenType)]),hr=relations(re,({one:r})=>({user:r(m,{fields:[re.userId],references:[m.id]})})),Er=relations(m,({many:r})=>({accounts:r(re),sessions:r(S)})),yr=relations(S,({one:r})=>({user:r(m,{fields:[S.userId],references:[m.id]})}));var he={};_e(he,{media:()=>N});var N=pgTable("media",{id:serial("id").primaryKey(),filename:varchar("filename",{length:255}).notNull(),originalFilename:varchar("original_filename",{length:255}).notNull(),mimeType:varchar("mime_type",{length:100}).notNull(),fileExtension:varchar("file_extension",{length:10}).notNull(),secureUrl:text("secure_url"),fileSize:bigint("file_size",{mode:"number"}).notNull(),width:integer("width"),height:integer("height"),duration:decimal("duration",{precision:10,scale:2}),storageKey:text("storage_key").notNull(),mediaType:text("media_type").notNull(),altText:text("alt_text"),caption:text("caption"),description:text("description"),tags:json("tags"),storageMetadata:json("storage_metadata"),..._});var Tr={...ge,...he},Fe=Tr;Or.config();var Nr=new Pr.Pool({connectionString:process.env.DATABASE_URL}),Ur=drizzle(Nr,{schema:Fe}),I=Ur;var b=class{db;currentTx=null;constructor(){this.db=I;}setTransaction(e){return this.currentTx=e,this}clearTransaction(){return this.currentTx=null,this}getDb(){return this.currentTx||this.db}};var Ee=class{clientDomain=null;serverDomain=null;setClientDomain(e){this.clientDomain=e;}getClientDomain(){return this.clientDomain}setServerDomain(e){this.serverDomain=e;}getServerDomain(){return this.serverDomain}},_r=new Ee,M=_r;var R=class{static detectInputType(e){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?"EMAIL":"USERNAME"}static OTPGenerator(e=4){if(e<4)throw new Error("The OTP length must be at least 4.");let s=Math.pow(10,e-1),t=Math.pow(10,e)-1;return Math.floor(Math.random()*(t-s+1)+s)}static OTPExpiry(e=5){let s=new Date;return new Date(s.getTime()+e*6e4)}static sameSiteCookieConfig(){try{let e=x=>/^(\d{1,3}\.){3}\d{1,3}$/.test(x);if(process.env.COOKIE_SETTINGS==="locally")return {sameSite:"lax",secure:!1};if(process.env.COOKIE_SETTINGS==="globally"&&process.env.COOKIE_DOMAIN){let x=process.env.COOKIE_DOMAIN,U=x.startsWith(".")?x.substring(1):x;return e(U)?{sameSite:process.env.COOKIE_SAME_SITE,secure:!0,domain:x}:{sameSite:process.env.COOKIE_SAME_SITE,secure:!0,domain:x}}let s=M.getClientDomain(),t=M.getServerDomain()||process.env.API_URL;if(!s)return {sameSite:"none",secure:!0};let o=new URL(s),n=new URL(t),p=n.protocol==="https:",d=x=>x.split(":")[0],l=x=>{let U=d(x);if(U==="localhost"||e(U))return U;let Ue=U.split(".");return Ue.length<2?U:Ue.slice(-2).join(".")},y=l(o.hostname),fr=l(n.hostname),ee,H;return d(o.hostname)===d(n.hostname)?(ee=d(n.hostname),H="lax"):y===fr&&!e(y)&&y!=="localhost"?(ee="."+y,H="lax"):(ee=d(n.hostname),H="none"),H==="none"&&(p=!0),{sameSite:H,secure:p,domain:ee}}catch{return {sameSite:"lax",secure:true}}}};var Ir=r=>r!==null&&typeof r=="object"&&"status"in r&&typeof r.status=="number"&&"message"in r&&typeof r.message=="string",Me=new Set([StatusCodes.NO_CONTENT]),i=class{static async createResponse(e,s,t,o){return Me.has(e)?Promise.resolve({status:e,message:s,data:void 0}):Promise.resolve({status:e,message:s,data:t,pagination:o})}static async createRejectResponse(e,s){return Promise.reject({status:e,message:s})}static createErrorResponse(e){return console.error("Error:",e instanceof Error?e.message:e),Ir(e)?Promise.reject(e):Promise.reject({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Internal Server Error"})}},v=class{response;constructor(e){this.response=e;}successResponse(e,s,t){return this.sendResponse({status:StatusCodes.OK,message:e,data:s,pagination:t})}unauthorizedResponse(e){return this.sendResponse({status:StatusCodes.UNAUTHORIZED,message:e})}forbiddenResponse(e){return this.sendResponse({status:StatusCodes.FORBIDDEN,message:e})}badResponse(e){return this.sendResponse({status:StatusCodes.BAD_REQUEST,message:e})}internalServerError(e="Internal Server Error"){return this.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:e})}sendResponse({status:e,message:s,data:t,pagination:o}){if(Me.has(e))return this.response.status(e).json({});let n={status:e,message:s};return t!==void 0&&(n.data=t),o&&(n.pagination=o),this.response.status(e).json(n)}};var D=class extends b{async createUser(e){try{e.username&&await this.duplicateUserCheckByUsername(e.username),e.email&&await this.duplicateUserCheckByEmail(e.email);let s=await this.getDb().insert(m).values(e).returning(),{password:t,...o}=s[0];return i.createResponse(StatusCodes.CREATED,"User created successfully",o)}catch(s){return i.createErrorResponse(s)}}async findUserByUsernameOrEmail(e){try{let s=R.detectInputType(e),t={};return s==="EMAIL"?(t=(await this.findUserByEmail(e,!0)).data,i.createResponse(StatusCodes.OK,"User found successfully",t)):s==="USERNAME"?(t=(await this.findUserByUsername(e,!0)).data,i.createResponse(StatusCodes.OK,"User found successfully",t)):i.createResponse(StatusCodes.BAD_REQUEST,"Invalid input type",t)}catch(s){return i.createErrorResponse(s)}}async findUserById(e,s=false){try{let t=await this.getDb().query.users.findFirst({where:eq(m.id,e)});if(!t)return i.createRejectResponse(StatusCodes.NOT_FOUND,"User not found");if(s)return i.createResponse(StatusCodes.OK,"User found successfully",t);let{password:o,...n}=t;return i.createResponse(StatusCodes.OK,"User found successfully",n)}catch(t){return i.createErrorResponse(t)}}async findUserByEmail(e,s=false){try{let t=await this.getDb().query.users.findFirst({where:eq(m.email,e)});if(!t)return i.createRejectResponse(StatusCodes.NOT_FOUND,"User not found");if(s)return i.createResponse(StatusCodes.OK,"User found successfully",t);let{password:o,...n}=t;return i.createResponse(StatusCodes.OK,"User found successfully",n)}catch(t){return i.createErrorResponse(t)}}async findUserByUsername(e,s=false){try{let t=await this.getDb().query.users.findFirst({where:eq(m.username,e)});if(!t)return i.createRejectResponse(StatusCodes.NOT_FOUND,"User not found");if(s)return i.createResponse(StatusCodes.OK,"User found successfully",t);let{password:o,...n}=t;return i.createResponse(StatusCodes.OK,"User found successfully",n)}catch(t){return i.createErrorResponse(t)}}async duplicateUserCheckByEmail(e){try{return await this.getDb().query.users.findFirst({where:eq(m.email,e)})?i.createRejectResponse(StatusCodes.CONFLICT,"User already exists"):i.createResponse(StatusCodes.OK,"User does not exist",!1)}catch(s){return i.createErrorResponse(s)}}async duplicateUserCheckByUsername(e){try{return await this.getDb().query.users.findFirst({where:eq(m.username,e)})?i.createRejectResponse(StatusCodes.CONFLICT,"User already exists"):i.createResponse(StatusCodes.OK,"User does not exist",!1)}catch(s){return i.createErrorResponse(s)}}async changePassword(e,s){try{let t=await Le.hash(s,10);return await this.getDb().update(m).set({password:t}).where(eq(m.id,e)),i.createResponse(StatusCodes.OK,"Password changed successfully",!0)}catch(t){return i.createErrorResponse(t)}}async passwordChecker(e,s){try{if(!s)return i.createRejectResponse(StatusCodes.NOT_FOUND,"User account has no password");let t=await Le.compare(e,s);return t?i.createResponse(StatusCodes.OK,"Password checked",t):i.createRejectResponse(StatusCodes.NOT_FOUND,"Password incorrect")}catch(t){return i.createErrorResponse(t)}}async accountVerification(e){try{return await this.getDb().update(m).set({emailVerified:new Date}).where(eq(m.id,e)),i.createResponse(StatusCodes.OK,"User verified",!0)}catch(s){return i.createErrorResponse(s)}}async checkAccountVerification(e){try{return (await this.findUserById(e)).data?.emailVerified?i.createResponse(StatusCodes.OK,"User is verified",!0):i.createRejectResponse(StatusCodes.NOT_FOUND,"User is not verified")}catch(s){return i.createErrorResponse(s)}}};var a={error:{required:{fieldIsRequired:r=>`${r} is required.`},limit:{stringMin:(r,e)=>`${r} must be at least ${e} characters.`,stringMax:(r,e)=>`${r} must not exceed ${e} characters.`,arrayMin:(r,e)=>`${r} must have at least ${e} items.`,arrayMax:(r,e)=>`${r} must not exceed ${e} items.`,numberMin:(r,e)=>`${r} must be at least ${e}.`,numberMax:(r,e)=>`${r} must not exceed ${e}.`,fileSize:(r,e)=>`${r} must not exceed ${e}.`,length:(r,e)=>`${r} must be exactly ${e} characters long.`},invalid:{invalidString:r=>`${r} must be a string.`,invalidEmail:r=>`${r} must be a valid email address.`,invalidNumber:r=>`${r} must be a number.`,invalidBoolean:r=>`${r} must be a boolean.`,invalidDate:r=>`${r} must be a date.`,invalidArray:r=>`${r} must be an array.`,invalidObject:r=>`${r} must be an object.`,invalidEnum:(r,e)=>`${r} must be one of the following values: ${e.join(", ")}.`,invalidUnion:r=>`${r} must be one of the specified types.`,invalidIntersection:r=>`${r} must be a combination of the specified types.`,invalidTuple:r=>`${r} must be a tuple.`,invalidRecord:r=>`${r} must be a record.`,invalidLiteral:(r,e)=>`${r} must be the literal value: ${e}.`,invalidNull:r=>`${r} must be null.`,invalidUndefined:r=>`${r} must be undefined.`,invalidOptional:r=>`${r} must be optional.`,invalidNullable:r=>`${r} must be nullable.`,invalidPromise:r=>`${r} must be a promise.`,invalidFunction:r=>`${r} must be a function.`,invalidClass:r=>`${r} must be a class.`,invalidUnknown:r=>`${r} must be unknown.`,invalidNever:r=>`${r} must be never.`,invalidVoid:r=>`${r} must be void.`,invalidAny:r=>`${r} must be any.`,invalidUnknownKeys:r=>`${r} must have unknown keys.`,invalidFile:r=>`${r} must be a file.`,invalidFileSize:(r,e)=>`${r} must not exceed ${e} bytes.`,invalidFileType:(r,e)=>`${r} must be of type ${e}.`,invalidUpperCase:r=>`${r} must be at least one upper case.`,invalidLowerCase:r=>`${r} must be at least one lower case.`,invalidNumericCase:r=>`${r} must be at least one number.`,invalidPhoneNumber:r=>`${r} must be a valid phone number.`,invalidUsername:r=>`${r} must contain only letters, numbers, and underscores.`,invalidUsernameOrEmail:r=>`${r} must be a valid username or email address.`}}};var g=r=>z$1.string({error:e=>e.input===void 0?a.error.required.fieldIsRequired(r):a.error.invalid.invalidString(r)}).min(1,a.error.required.fieldIsRequired(r));var ye=r=>z$1.number({error:e=>e.input===void 0?a.error.required.fieldIsRequired(r):a.error.invalid.invalidString(r)}).min(1,a.error.required.fieldIsRequired(r)).int().positive();var L=(r,e)=>z$1.enum(e,{error:s=>s.input===void 0?a.error.required.fieldIsRequired(r):a.error.invalid.invalidString(r)});z$1.string({error:r=>r.input===void 0?a.error.required.fieldIsRequired("Username"):a.error.invalid.invalidString("Username")}).min(1,a.error.required.fieldIsRequired("Username")).max(20,a.error.limit.stringMax("Username",20)).regex(new RegExp("^[a-zA-Z0-9_]*$"),a.error.invalid.invalidUsername("Username"));var ie=z$1.email(a.error.invalid.invalidEmail("Email")).min(1,a.error.required.fieldIsRequired("Email"));var ze=z$1.string({error:r=>r.input===void 0?a.error.required.fieldIsRequired("Username or email"):a.error.invalid.invalidString("Username or email")}).min(1,a.error.required.fieldIsRequired("Username or email")).max(255,a.error.limit.numberMax("Username or email",255)).refine(r=>{let e=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,s=/^[a-zA-Z0-9_]*$/;return r.includes("@")?e.test(r):s.test(r)&&r.length>=1&&r.length<=20},a.error.invalid.invalidUsernameOrEmail("Username or email")),Se=z$1.string({error:r=>r.input===void 0?a.error.required.fieldIsRequired("Password"):a.error.invalid.invalidString("Password")}).min(1,a.error.required.fieldIsRequired("Password")).min(6,a.error.limit.stringMin("Password",6)).regex(new RegExp(".*[A-Z].*"),a.error.invalid.invalidUpperCase("Password")).regex(new RegExp(".*[a-z].*"),a.error.invalid.invalidLowerCase("Password")).regex(new RegExp(".*\\d.*"),a.error.invalid.invalidNumericCase("Password")),je=z$1.string({error:r=>r.input===void 0?a.error.required.fieldIsRequired("New Password"):a.error.invalid.invalidString("New Password")}).min(1,a.error.required.fieldIsRequired("New Password")).min(6,a.error.limit.stringMin("New Password",6)).regex(new RegExp(".*[A-Z].*"),a.error.invalid.invalidUpperCase("New Password")).regex(new RegExp(".*[a-z].*"),a.error.invalid.invalidLowerCase("New Password")).regex(new RegExp(".*\\d.*"),a.error.invalid.invalidNumericCase("New Password"));z$1.string({error:r=>r.input===void 0?a.error.required.fieldIsRequired("Confirm Password"):a.error.invalid.invalidString("Confirm Password")}).min(1,a.error.required.fieldIsRequired("Confirm Password")).min(6,a.error.limit.stringMin("Confirm Password",6)).regex(new RegExp(".*[A-Z].*"),a.error.invalid.invalidUpperCase("Confirm Password")).regex(new RegExp(".*[a-z].*"),a.error.invalid.invalidLowerCase("Confirm Password")).regex(new RegExp(".*\\d.*"),a.error.invalid.invalidNumericCase("Confirm Password"));var Ke=r=>z$1.boolean({error:e=>e.input===void 0?a.error.required.fieldIsRequired(r):a.error.invalid.invalidString(r)});var Be=z$1.object({usernameOrEmail:ze,password:g("Password")}),Ve=z$1.object({email:ie}),He=z$1.object({email:ie,otp:ye("OTP"),verificationMethod:L("Verification Method",P.enumValues)}),Ye=z$1.object({email:ie,otp:ye("OTP"),password:Se});z$1.object({oldPassword:Se,newPassword:je});var z=class{request;response;apiResponse;constructor(e,s){this.request=e,this.response=s,this.apiResponse=new v(s);}};var W=class extends b{async limitOTPRequest(e,s,t){try{let o=await this.getDb().query.verificationToken.findFirst({where:and(eq(w.identifier,e.email),eq(w.tokenType,s))}),n=new Date().getTime(),p=new Date(o?.updatedAt).getTime(),d=n-p,l=Math.floor(d/6e4);if(o&&l<t){let y=`You can only request OTP per ${t} minute(s). Please wait for ${t-l} minute(s)`;return i.createRejectResponse(StatusCodes.TOO_MANY_REQUESTS,y)}return Promise.resolve(!0)}catch(o){return i.createErrorResponse(o)}}async saveOTPToDatabase(e,s,t=Number(process.env.OTP_RESET_EXPIRY)){try{if(!e.email)return i.createRejectResponse(StatusCodes.NOT_FOUND,"Email is not registered");let o=new Date,n=new Date(o.getTime()+t*6e4);await this.limitOTPRequest(e,s,t);let p=R.OTPGenerator(6),d=Le.hashSync(String(p),10);return await this.getDb().insert(w).values({identifier:e.email,token:d,tokenType:s,expires:n}).onConflictDoUpdate({target:[w.identifier,w.tokenType],set:{token:d,expires:n}}),Promise.resolve(p)}catch(o){return i.createErrorResponse(o)}}async verifyOTPFromDatabase(e,s,t){try{let o=await this.getDb().query.verificationToken.findFirst({where:and(eq(w.identifier,e.email),eq(w.tokenType,t))});return o&&o.token&&!Le.compareSync(s,o.token)?i.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid OTP"):o?o?.expires&&o.expires<new Date?(await this.deleteOTPFromDatabase(e,t),i.createRejectResponse(StatusCodes.REQUEST_TIMEOUT,"OTP expired")):Promise.resolve(!0):i.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid OTP")}catch(o){return i.createErrorResponse(o)}}async deleteOTPFromDatabase(e,s){try{return await this.getDb().delete(w).where(and(eq(w.identifier,e.email),eq(w.tokenType,s))),Promise.resolve(!0)}catch(t){return i.createErrorResponse(t)}}};var O=class extends z{authenticationService;otpService;constructor(e,s){super(e,s),this.authenticationService=new D,this.otpService=new W;}async getSession(){let{user:e}=this.request;return e?this.apiResponse.successResponse("Authorized",e):this.apiResponse.successResponse("No session found")}async verifyOTP(){let{body:e}=this.request,s=He.safeParse(e);if(!s.success)return this.apiResponse.badResponse(s.error.issues.map(o=>o.message).join(" "));let t=await this.authenticationService.findUserByEmail(s.data.email);return await this.otpService.verifyOTPFromDatabase(t.data,String(s.data.otp),s.data.verificationMethod),this.apiResponse.successResponse("OTP verified successfully")}async login(){let{body:e}=this.request,s=Be.safeParse(e);if(!s.success)return this.apiResponse.badResponse(s.error.issues.map(p=>p.message).join(" "));let t=await this.authenticationService.findUserByUsernameOrEmail(s.data.usernameOrEmail);await this.authenticationService.checkAccountVerification(t.data.id),await this.authenticationService.passwordChecker(s.data.password,t.data.password);let{password:o,...n}=t.data;this.request.login(t.data,p=>p?this.apiResponse.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Login failed"}):this.apiResponse.successResponse("Login successful",n));}async logout(){this.request.session.destroy(e=>e?this.apiResponse.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Error logging out"}):(this.response.clearCookie(process.env.SESSION_COOKIE_NAME),this.apiResponse.successResponse("Logged out")));}async resetPasswordOTPRequest(){let{body:e}=this.request,s=Ve.safeParse(e);if(!s.success)return this.apiResponse.badResponse(s.error.issues.map(n=>n.message).join(" "));let t=await this.authenticationService.findUserByEmail(e.email),o=await this.otpService.saveOTPToDatabase(t.data,P.PASSWORD_RESET);return o&&t.data.email,process.env.SHOW_OTP?(console.log(`OTP for user ${t.data.username}: ${o}`),this.apiResponse.successResponse("OTP sent to your email",{otp:o,otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})):this.apiResponse.successResponse("Password reset OTP sent",{otpExpirationTime:Number(process.env.OTP_RESET_EXPIRY)})}async resetPasswordConfirm(){let{body:e}=this.request,s=Ye.safeParse(e);if(!s.success)return this.apiResponse.badResponse(s.error.issues.map(o=>o.message).join(", "));let t=await this.authenticationService.findUserByEmail(s.data.email);return await this.otpService.verifyOTPFromDatabase(t.data,String(s.data.otp),P.PASSWORD_RESET),await this.otpService.deleteOTPFromDatabase(t.data,P.PASSWORD_RESET),await this.authenticationService.changePassword(t.data.id,s.data.password),this.apiResponse.successResponse("User password reset")}};function Cr(r,e,s,t){let o=new v(s);if(kr(r,e),r instanceof ZodError){qr(r,o);return}if(r.name==="ValidationError"){$r(r,o);return}if(r.name==="CastError"){Fr(r,o);return}if(r.name==="MongoError"||r.name==="MongoServerError"){Mr(r,o);return}if(r.code==="ECONNREFUSED"){Lr(r,o);return}if(r.name==="JsonWebTokenError"){zr(r,o);return}if(r.name==="TokenExpiredError"){jr(r,o);return}if(r.name==="SyntaxError"&&r.message.includes("JSON")){Kr(r,o);return}if(r.code==="LIMIT_FILE_SIZE"){Br(r,o);return}if(r.code==="EBADCSRFTOKEN"){Vr(r,o);return}if(r.status||r.statusCode){Hr(r,o);return}Yr(r,o);}function Dr(r,e){new v(e).sendResponse({status:StatusCodes.NOT_FOUND,message:`Route ${r.method} ${r.originalUrl} not found`});}function E(r){return (e,s,t)=>{Promise.resolve(r(e,s,t)).catch(t);}}function Ze(r){r.use(Dr),r.use(Cr);}function kr(r,e){let s=new Date().toISOString(),t=e.method,o=e.originalUrl,n=e.get("User-Agent")||"Unknown",p=e.ip||e.socket.remoteAddress||"Unknown";console.error(u.red("=".repeat(80))),console.error(u.red(`\u{1F6A8} ERROR OCCURRED AT: ${s}`)),console.error(u.yellow(`\u{1F4DD} REQUEST: ${t} ${o}`)),console.error(u.cyan(`\u{1F310} IP: ${p}`)),console.error(u.cyan(`\u{1F50D} User-Agent: ${n}`)),console.error(u.red(`\u274C ERROR NAME: ${r.name||"Unknown"}`)),console.error(u.red(`\u{1F4AC} ERROR MESSAGE: ${r.message||"No message"}`)),r.stack&&(console.error(u.gray("\u{1F4DA} STACK TRACE:")),console.error(u.gray(r.stack))),console.error(u.red("=".repeat(80)));}function qr(r,e){let s=r.issues.map(t=>({field:t.path.join("."),message:t.message}));e.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:s}});}function $r(r,e){let s=Object.values(r.issues||{}).map(t=>({field:t.path,message:t.message}));e.sendResponse({status:StatusCodes.BAD_REQUEST,message:"Validation failed",data:{errors:s}});}function Fr(r,e){e.badResponse(`Invalid ${r.path}: ${r.value}`);}function Mr(r,e){if(r.code===11e3){let s=Object.keys(r.keyValue||{})[0];e.sendResponse({status:StatusCodes.CONFLICT,message:`Duplicate value for field: ${s}`});return}e.internalServerError("Database operation failed");}function Lr(r,e){e.sendResponse({status:StatusCodes.SERVICE_UNAVAILABLE,message:"Database connection failed. Please try again later."});}function zr(r,e){e.unauthorizedResponse("Invalid authentication token");}function jr(r,e){e.unauthorizedResponse("Authentication token has expired");}function Kr(r,e){e.badResponse("Invalid JSON format in request body");}function Br(r,e){e.badResponse("File size exceeds the allowed limit");}function Vr(r,e){e.forbiddenResponse("Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.");}function Hr(r,e){let s=r.status||r.statusCode||StatusCodes.INTERNAL_SERVER_ERROR,t=r.message||"An error occurred";e.sendResponse({status:s,message:t});}function Yr(r,e){e.sendResponse({status:StatusCodes.INTERNAL_SERVER_ERROR,message:"Something went wrong. Please try again later."});}function Je(){process.on("uncaughtException",r=>{console.error(u.red("\u{1F6A8} UNCAUGHT EXCEPTION:")),console.error(u.red(r.name+": "+r.message)),console.error(u.gray(r.stack)),console.log(u.yellow("\u{1F504} Attempting graceful shutdown...")),process.exit(1);}),process.on("unhandledRejection",(r,e)=>{console.error(u.red("\u{1F6A8} UNHANDLED PROMISE REJECTION:")),console.error(u.red("Reason:"),r),console.error(u.yellow("Promise:"),e),console.log(u.yellow("\u{1F504} Attempting graceful shutdown...")),process.exit(1);}),process.on("SIGTERM",()=>{console.log(u.yellow("\u{1F6D1} SIGTERM received. Starting graceful shutdown...")),process.exit(0);}),process.on("SIGINT",()=>{console.log(u.yellow("\u{1F6D1} SIGINT received. Starting graceful shutdown...")),process.exit(0);});}var Gr=process.env.SESSION_COOKIE_NAME,Wr=async(r,e,s)=>{let t=new v(e);if(!r.isAuthenticated()){e.clearCookie(Gr),t.unauthorizedResponse("Unauthorized: Not authenticated");return}s();},Xe=E(Wr);var Qe=(()=>{let r=Ne.Router();return r.get("/me",E(async(e,s)=>{await new O(e,s).getSession();})),r.post("/verify-otp",E(async(e,s)=>{await new O(e,s).verifyOTP();})),r.post("/login",E(async(e,s)=>{await new O(e,s).login();})),r.post("/reset-password/request",E(async(e,s)=>{await new O(e,s).resetPasswordOTPRequest();})),r.post("/reset-password/confirm",E(async(e,s)=>{await new O(e,s).resetPasswordConfirm();})),r.post("/logout",Xe,E(async(e,s)=>{await new O(e,s).logout();})),r})();var Z=["image/jpeg","image/jpg","image/png","image/gif","image/webp","image/svg+xml","video/mp4","video/webm","audio/mp3","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain"];var B=class{constructor(){v2.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET});}async singleUpload(e){try{if(typeof e=="string"){let t=await v2.uploader.upload(e);return i.createResponse(StatusCodes.OK,"Upload successful",t)}if(e instanceof Buffer){let t=await this.uploadBuffer(e);return i.createResponse(StatusCodes.OK,"Upload successful",t)}let s=e;if(s.buffer){let t=await this.uploadBufferWithMetadata(s.buffer,{originalname:s.originalname,mimetype:s.mimetype,size:s.size,fieldname:s.fieldname,encoding:s.encoding});return i.createResponse(StatusCodes.OK,"Upload successful",t)}if(s.path){let t={context:{original_filename:s.originalname,mime_type:s.mimetype,file_size:s.size.toString(),field_name:s.fieldname,encoding:s.encoding}},o=await v2.uploader.upload(s.path,t);return i.createResponse(StatusCodes.OK,"Upload successful",o)}return i.createRejectResponse(StatusCodes.BAD_REQUEST,"Invalid file - no buffer or path found")}catch(s){return i.createErrorResponse(s)}}uploadBuffer(e){return new Promise((s,t)=>{v2.uploader.upload_stream({},(n,p)=>{n?t(n):p?s(p):t(new Error("Upload failed - no result returned"));}).end(e);})}uploadBufferWithMetadata(e,s){return new Promise((t,o)=>{let n={context:{original_filename:s.originalname,mime_type:s.mimetype,file_size:s.size.toString(),field_name:s.fieldname,encoding:s.encoding},tags:["uploaded_file"]};v2.uploader.upload_stream(n,(d,l)=>{d?o(d):l?t(l):o(new Error("Upload failed - no result returned"));}).end(e);})}sanitizeFilename(e){return e.replace(/\.[^/.]+$/,"").toLowerCase().replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}async multipleUpload(e){try{let s=e.map(p=>this.singleUpload(p)),t=await Promise.allSettled(s),o=[],n=[];return t.forEach((p,d)=>{p.status==="fulfilled"&&p.value.data?o.push(p.value.data):n.push(`File ${d+1}: ${p.status==="rejected"?p.reason:"Upload failed"}`);}),n.length>0&&o.length===0?i.createRejectResponse(StatusCodes.BAD_REQUEST,`All uploads failed: ${n.join(", ")}`):i.createResponse(StatusCodes.OK,`Upload successful (${o.length}/${e.length} files)`,o)}catch(s){return i.createErrorResponse(s)}}async deleteFile(e){try{return (await v2.uploader.destroy(e)).result==="ok"}catch(s){return console.error("Error deleting file from Cloudinary:",s),false}}};var X=class extends b{cloudinarySettings;constructor(){super(),this.cloudinarySettings=new B;}async upload(e){try{return await this.getDb().insert(N).values({filename:e.display_name,originalFilename:e.original_filename,mediaType:e.resource_type,fileSize:e.bytes,fileExtension:e.format,mimeType:`${e.resource_type}/${e.format}`,storageKey:e.public_id,height:e.height,width:e.width,secureUrl:e.secure_url,storageMetadata:e}),i.createResponse(StatusCodes.OK,"Media uploaded successfully",!0)}catch(s){return i.createErrorResponse(s)}}async retrieveAll(){try{let e=await this.getDb().query.media.findMany();return i.createResponse(StatusCodes.OK,"Media retrieved successfully",e)}catch(e){return i.createErrorResponse(e)}}async updateMediaFileName(e,s){try{return await this.getDb().update(N).set({filename:s}).where(eq(N.id,e)),i.createResponse(StatusCodes.OK,"Media file name updated",!0)}catch(t){return i.createErrorResponse(t)}}async deleteMedia(e){try{let s=await this.getDb().query.media.findFirst({where:eq(N.id,e)});return s?(await this.cloudinarySettings.deleteFile(s.storageKey),await this.getDb().delete(N).where(eq(N.id,e)),i.createResponse(StatusCodes.OK,"Media deleted successfully",!0)):i.createRejectResponse(StatusCodes.NOT_FOUND,"Media item not found")}catch(s){return i.createErrorResponse(s)}}};var er=Jr.object({name:g("Media Name")});var V=class extends z{cloudinarySettings;mediaService;constructor(e,s){super(e,s),this.cloudinarySettings=new B,this.mediaService=new X;}async index(){let e=await this.mediaService.retrieveAll();return this.apiResponse.sendResponse(e)}async upload(){let e=this.request.files,s=await this.cloudinarySettings.multipleUpload(e),t={...s.data[0],original_filename:e[0].originalname,asset_id:s.data[0].asset_id,version_id:s.data[0].version_id,asset_folder:s.data[0].asset_folder,display_name:s.data[0].display_name,api_key:s.data[0].api_key},o=await this.mediaService.upload(t);return this.apiResponse.sendResponse(o)}async updateFileName(){let{body:e,params:s}=this.request,t=Number(s.id);if(isNaN(t))return this.apiResponse.badResponse("Invalid media ID provided.");let o=er.safeParse(e);if(!o.success)return this.apiResponse.badResponse(o.error.issues.map(p=>p.message).join(", "));let n=await this.mediaService.updateMediaFileName(t,o.data.name);return this.apiResponse.sendResponse(n)}};var rr=(r,e,s)=>{let t=r.files,o=new v(e);if(!t||t.length===0)return o.badResponse("No files uploaded");if(t.length>1)return o.badResponse(`Maximum ${1} files allowed per upload`);for(let n of t){if(n.size>10485760)return o.badResponse(`File ${n.originalname} exceeds maximum size of ${10485760/(1024*1024)}MB`);if(!Z.includes(n.mimetype))return o.badResponse(`File type ${n.mimetype} is not allowed. Allowed types: ${Z.join(", ")}`);if(!n.originalname||n.originalname.trim()==="")return o.badResponse("File must have a valid name");let p=[".exe",".bat",".cmd",".com",".pif",".scr",".vbs",".js"],d=n.originalname.toLowerCase().substring(n.originalname.lastIndexOf("."));if(p.includes(d))return o.badResponse(`File type ${d} is not allowed for security reasons`)}s();};var es=Qr({limits:{fileSize:10485760,files:1},fileFilter:(r,e,s)=>{Z.includes(e.mimetype)?s(null,true):s(new Error(`File type ${e.mimetype} is not allowed`));}}),sr=(()=>{let r=Ne.Router();return r.get("",E(async(e,s)=>{await new V(e,s).index();})),r.post("/upload",es.any(),rr,E(async(e,s)=>{await new V(e,s).upload();})),r})();var{generateCsrfToken:tr,validateRequest:Uo,doubleCsrfProtection:_o,invalidCsrfTokenError:Io}=doubleCsrf({getSecret:()=>process.env.SECRET,getSessionIdentifier:()=>process.env.SECRET,cookieName:"csrf-token",cookieOptions:{maxAge:36e5,sameSite:R.sameSiteCookieConfig().sameSite,secure:R.sameSiteCookieConfig().secure,...R.sameSiteCookieConfig().domain&&{domain:R.sameSiteCookieConfig().domain}},size:32,errorConfig:{message:"Invalid CSRF token. Perhaps your browser blocked 3rd-party cookies. Please allow 3rd-party cookies or try a different browser. If the problem persists, please contact support.",statusCode:403},getCsrfTokenFromRequest:r=>r.headers["x-csrf-token"]});var or=(()=>{let r=Ne.Router();return r.get("",E(async(e,s)=>{let t=tr(e,s);new v(s).successResponse("CSRF token generated",t);})),r})();var ir=[{path:"/csrf-token",router:or},{path:"/auth",router:Qe},{path:"/media",router:sr}];function xe(r,e=""){let s=[];for(let{path:t,router:o}of ir){let n=`${e}${t}`;r.use(n,o),o.stack.forEach(p=>{p.route&&Object.keys(p.route.methods).forEach(l=>{s.push({method:l.toUpperCase(),path:`${n}${p.route.path}`});});});}}var nr={origin:function(r,e){!r||process.env.ORIGIN_URL.split(",").includes(r)?e(null,true):e(new Error("Not allowed by CORS"));},credentials:true,methods:["GET","POST","PUT","DELETE"],allowedHeaders:["Content-Type","Authorization","x-csrf-token","ngrok-skip-browser-warning"],maxAge:3600};function Te(r){r.use((e,s,t)=>{let{method:o,url:n}=e,p=Date.now();console.log(`${u.green("\u2713")} ${o} ${n}`),s.on("finish",()=>{let d=Date.now()-p,l=s.statusCode,y;l>=500?y=u.red(l.toString()):l>=400?y=u.yellow(l.toString()):l>=300?y=u.cyan(l.toString()):l>=200?y=u.green(l.toString()):y=u.red("500"),console.log(`${u.green("\u2713")} ${o} ${n} ${y} in ${d}ms`);}),t();});}var pe=new D;ce.serializeUser((r,e)=>{e(null,r.id);});ce.deserializeUser(async(r,e)=>{try{let s=await pe.findUserById(r,!1);s.data?e(null,s.data):e(new Error("User not found"),null);}catch(s){e(s,null);}});ce.use(new Strategy({usernameField:"usernameOrEmail",passwordField:"password"},async(r,e,s)=>{try{let t=await pe.findUserByUsernameOrEmail(r);if(!t.data)return s(null,!1,{message:"Invalid credentials"});if(!(await pe.passwordChecker(e,t.data.password)).data)return s(null,!1,{message:"Invalid credentials"});let n=await pe.findUserById(t.data.id,!1);return s(null,n.data)}catch(t){return s(t)}}));var Oe=ce;function be(r){let e=is({windowMs:9e5,max:100,message:"Too many requests, please try again later."});r.use(e);}var Q=class extends Store{async get(e,s){try{let t=await I.select().from(S).where(eq(S.sessionId,e)).execute();if(!t||t.length===0)return s(null,null);let o=t[0];return new Date(o.expires)<new Date?(await this.destroy(e),s(null,null)):s(null,JSON.parse(o.sessionCookie))}catch(t){return s(t)}}async set(e,s,t){try{if(!s)return t?.();let o=JSON.stringify(s),n=s.cookie.expires||new Date(Date.now()+6048e5),p=s?.passport?.user||null;await I.insert(S).values({sessionId:e,sessionCookie:o,userId:p,expires:n}).onConflictDoUpdate({target:S.sessionId,set:{sessionCookie:o,userId:p,expires:n}}).returning(),t?.();}catch(o){t?.(o);}}async destroy(e,s){try{await I.delete(S).where(eq(S.sessionId,e)).execute(),s?.();}catch(t){s?.(t);}}async touch(e,s,t){try{let o=s.cookie.expires||new Date(Date.now()+6048e5);await I.update(S).set({expires:o}).where(eq(S.sessionId,e)).execute(),t?.();}catch{t?.();}}};var ps=as({name:process.env.SESSION_COOKIE_NAME,secret:process.env.SECRET,saveUninitialized:false,resave:false,store:new Q,cookie:{sameSite:R.sameSiteCookieConfig().sameSite,secure:R.sameSiteCookieConfig().secure,maxAge:6048e5,...R.sameSiteCookieConfig().domain&&{domain:R.sameSiteCookieConfig().domain}}}),ar=ps;var cs=(r,e,s)=>{let t=r.secure?"https":"http",o=r.headers.origin||r.headers.referer||"Unknown",n=o!=="Unknown"?new URL(o.toString()).origin:"Unknown",p=r.headers.host?`${t}://${r.headers.host}`:"Unknown";M.setClientDomain(n),M.setServerDomain(p),s();},pr=cs;Or.config();var h=Ne();h.use(fs());h.use(Ne.json());h.use(urlencoded({extended:true}));h.use(Ne.urlencoded({extended:true}));h.use(ds());h.use(us(nr));Te(h);be(h);h.use(pr);h.set("trust proxy",1);h.use(ar);h.use(Oe.initialize());h.use(Oe.session());ue(h);xe(h);Ze(h);var cr=h;var hs=z$1.object({DATABASE_URL:g("DATABASE_URL"),PORT:g("PORT").refine(r=>!isNaN(Number(r)),"PORT must be a number"),SECRET:g("SECRET"),NODE_ENV:L("NODE_ENV",["development","production"]),SESSION_COOKIE_NAME:g("SESSION_COOKIE_NAME"),ORIGIN_URL:g("ORIGIN_URL"),COOKIE_SETTINGS:L("COOKIE_SETTINGS",["locally","globally"]),COOKIE_DOMAIN:g("COOKIE_DOMAIN"),COOKIE_SAME_SITE:L("COOKIE_SAME_SITE",["lax","strict","none"]),OTP_RESET_EXPIRY:g("OTP_RESET_EXPIRY").refine(r=>!isNaN(Number(r)),"OTP_RESET_EXPIRY must be a number"),SHOW_OTP:g("SHOW_OTP").refine(r=>Ke(r)?true:"SHOW_OTP must be a boolean value (true or false)"),API_URL:g("API_URL"),CLOUDINARY_CLOUD_NAME:g("CLOUDINARY_CLOUD_NAME"),CLOUDINARY_API_KEY:g("CLOUDINARY_API_KEY"),CLOUDINARY_API_SECRET:g("CLOUDINARY_API_SECRET")}),dr=hs.safeParse(process.env);if(!dr.success){let r=dr.error.issues.map(e=>e.message).join(`
`);console.error(u.red(`Environment validation failed:
${r}`)),process.exit(1);}var Es=()=>{try{let r=join(process.cwd(),"package.json"),e=JSON.parse(readFileSync(r,"utf-8")),s=e.dependencies?.express||e.devDependencies?.express;if(s)return s.replace(/[\^~<>=\s]/g,"");let t=join(process.cwd(),"node_modules/express/package.json");return JSON.parse(readFileSync(t,"utf-8")).version}catch{return "unknown"}},mr=Es;var vs=mr();Je();var ws=async()=>{try{let r=process.env.PORT||8080,e=ys.address(),s="production";cr.listen(r,()=>{console.log(u.magenta(`
\u25B2 Express.js ${vs}`)),console.log(`- Local:        http://localhost:${r}`),console.log(`- Network:      http://${e}:${r}`),console.log(`- Environment:  ${s}`),console.log();});}catch(r){console.error("Failed to start server:",r),process.exit(1);}};ws();